#!/usr/bin/with-contenv bash

### !!! this file is also called at finish !!!


## default mount points (docker volumes)
declare -a chmown=("/etc/PKGBUILD.d"
		   "/etc/vdr"
		   "/srv/vdr/video"
		   "/var/cache/vdr"
		   "/var/lib/vdr"
		   "/vdr/timeshift"
		  )

for f in "${chmown[@]}"
do
	echo "Reassign permissions: $f"
	chown -R vdr:vdr "$f"
	find "$f" -type d -exec chmod 755 {} \;
	find "$f" -type f -exec chmod 664 {} \;
done


## Plugins
# live
live_dir="/vdr/config/plugins/live"
if [ -f "$live_dir/live.pem" ]; then
	chmod ug+r $live_dir/live.pem
fi
if [ -f "$live_dir/live-key.pem" ]; then
	chmod ug+r $live_dir/live-key.pem
fi

# ciplus
ci_plus="/vdr/cache/plugins/ciplus/"
if [ -d "$ci_plus" ] && [ ! -z "$(ls -A $ci_plus)" ]; then
	chmod -f ug+rw *.auth || true
fi


## protect cam.data
cam_data="/var/cache/vdr/cam.data"
if [ -f "$cam_data" ]; then
	if [ "$PROTECT_CAMDATA" = "true" ]; then
		chmod ug-w $cam_data
	else
		chmod ug+w $cam_data
	fi
fi
