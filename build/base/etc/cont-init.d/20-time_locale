#!/usr/bin/with-contenv bash

## set timezone
if [ -f "/usr/share/zoneinfo/$TZ" ]; then
	current_tz=$(readlink /etc/localtime)
	if [[ ! "$current_tz" =~ "$TZ" ]]; then
		rm -rf "/etc/localtime"
		ln -s "/usr/share/zoneinfo/$TZ" "/etc/localtime"
		echo "Timezone set to: $TZ"
	fi
elif [ ! -f "/usr/share/zoneinfo/$TZ" ]; then
	echo "Cannot set timezone: $TZ"
fi


## set locale
loc_file="/etc/locale.gen"

if [ -f "$loc_file" ]; then
	default_loc="en_US.UTF-8 UTF-8"
	loc_active=($(grep -v "^#" "$loc_file" | grep -v "^$" | grep -v "$default_loc" | cut -d " " -f1))
	if [[ ! -z "$loc_active" ]] && [[ ! "${loc_active[@]}" =~ "$LANG" ]]; then
		sed -i '/^[a-zA-Z0-9]/ s/^/#/' $loc_file
		sed -i "/$LANG/s/^# *//" $loc_file
		sed -i "/$default_loc/s/^# *//" $loc_file
		echo "LANG=$LANG" > /etc/locale.conf
		locale-gen
		echo "Locale set to: $LANG"
	fi
	if [ -z "$LANGUAGE" ]; then
		export LANGUAGE="$(echo "$LANG" | cut -d "." -f 1):$(echo "$LANG" | cut -d "_" -f 1)"
		printf "%s" "${LANGUAGE}" > /var/run/s6/container_environment/LANGUAGE
		echo "LANGUAGE variable not found, setting generated one: $LANGUAGE"
	fi
fi
