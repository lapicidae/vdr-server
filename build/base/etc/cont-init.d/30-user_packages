#!/usr/bin/with-contenv bash

# quit if AUR is disabled
if [ "$AUR" = "false" ]; then
	echo "AUR is disabled!"
	exit 0
fi


bUser="builduser"
pkgb_dir="/etc/PKGBUILD.d"
buildDir="/var/cache/paru/user_pkg"
vdrplug_conf="/etc/conf.d/user_plugins.conf"
pac_man="sudo -u $bUser paru --nouseask --removemake --cleanafter --noconfirm --noprogressbar --overwrite ´/usr/bin/*´ -Ui"


# array of subdirs sorted alphabetically
readarray -t package < <(find "$pkgb_dir" -mindepth 1 -maxdepth 1 -type d | LC_ALL=C sort -f)


for DIR in  "${package[@]}"; do

	pacname=$(basename "$DIR")
	dirmd5=$(find "$DIR" -type f \( ! -iname "rebuild" \) | LC_ALL=C sort | tar --mode="664" -cf - -T - 2>/dev/null | md5sum | cut -d " " -f 1)

	echo "****** USER PACKAGE: $pacname ******"

	# detox dir name
	pacname=$(echo "$pacname" | sed -e 's/[^A-Za-z0-9._-]/_/g' | sed 's/^_//g' | sed 's/_$//g')
	pacdir="$buildDir/$pacname"
	md5file="$pacdir/md5sum"


	# skip if md5sum matches or if PKGBUILD is missing
	if [ -f "$md5file" ] && [ "$dirmd5" = "$(cat $md5file 2>/dev/null)" ] && [ ! -f "$DIR/rebuild" ]; then
		echo "Nothing to do!"
		continue
	elif [ ! -f "$DIR/PKGBUILD" ]; then
		echo "Missing PKGBUILD file!"
		continue
	fi


	if [ ! -d "$pacdir" ]; then
		echo "create build dir..."
		mkdir -p "$pacdir"
		chown -R builduser:users "$buildDir"
	else
		echo "clear build dir..."
		rm -rf "$pacdir/"{*,.*} 2>/dev/null
	fi

	echo "copy to build dir..."
	cp -a "$DIR/." "$pacdir/"
	chown -R builduser:users "$pacdir"
	cd "$pacdir"

	echo "build package..."
	$pac_man || continue

	echo "cleanup..."
	rm -rf "$pacdir/"{*,.*} 2>/dev/null
	rm -f "$DIR/rebuild"
	echo "$dirmd5" > "$md5file"


	# enable VDR plugin if control file exists
	if [ 0 -lt $(ls "$DIR/vdrplug-"* 2>/dev/null | wc -w) ]; then
		vdrplug=$(find "$DIR" -maxdepth 1 -name "vdrplug-*" -exec basename {} \; | LC_ALL=C sort -f | head -n 1 | sed 's/^vdrplug-//')
		if ! grep -q "$vdrplug" "$vdrplug_conf"; then
			echo "enable vdr plugin $vdrplug..."
			echo "$vdrplug" >> "$vdrplug_conf"
			vdrctl enable "$vdrplug" && echo "Plugin $vdrplug enabled."
		fi
	fi

done
