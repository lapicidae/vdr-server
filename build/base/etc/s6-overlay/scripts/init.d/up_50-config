#!/command/with-contenv bash


main_dir="/vdr"
conf_dir="$main_dir/config"	# "/var/lib/vdr" equivalent
pkg_dir="$main_dir/pkgbuild"
sys_dir="$main_dir/system"	# "/etc/vdr" equivalent


# defaults
if [ -d "$main_dir" ]; then
	cp -RPpn /defaults/config/* $conf_dir
	cp -RPpn /defaults/pkgbuild/* $pkg_dir
	cp -RPpn /defaults/system/* $sys_dir
fi


# system
if [ -d "$sys_dir" ]; then
	# delete orphaned vdr plugin links
	find "$sys_dir/conf.d" -xtype l -delete

	# eMail config (msmtp)
	msmtp_conf="/etc/msmtprc"
	msmtp_conf_new="$sys_dir/eMail.conf"
	if [ -f "$msmtp_conf_new" ]; then
		CONF_COMP="$(cmp --silent $msmtp_conf $msmtp_conf_new; echo $?)"
		if [ $CONF_COMP != "0" ]; then	# only if files are not the same
			echo "Copy new eMail config"
			cp -f "$msmtp_conf_new" "$msmtp_conf"
			chown root:root $msmtp_conf
			chmod 640 $msmtp_conf
		fi
	fi
fi


# crontab naludump
if [ ${START_NALUDUMP:="false"} != "false" ] && [ ! -z "$START_NALUDUMP_AT" ]; then
	echo "Set naludump crontab to '$START_NALUDUMP_AT'"
	TMP_CRON=$(mktemp --suffix=".crontab")
	busybox crontab -u vdr -l > $TMP_CRON
	sed -i '/naludump/c\'"$START_NALUDUMP_AT"' /usr/local/bin/naludumper-cron' $TMP_CRON
	chown vdr:vdr $TMP_CRON
	busybox crontab -u vdr $TMP_CRON
	rm -f $TMP_CRON
fi
