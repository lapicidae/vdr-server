#! /bin/bash
VDR_CHECKTS="/usr/sbin/vdr-checkts"
REC_DIR="/vdr/recordings"


if [ ! -x "$VDR_CHECKTS" ]; then
   echo "Cannot execute VDR_CHECKTS=${VDR_CHECKTS}, exiting"
   exit 1
fi

trap 'echo KILLED; exit 130' INT


if [ -z "$1" ]; then
	readarray -t record < <(find "$REC_DIR/" -type d -regex '.*rec$' | LC_ALL=C sort -f)
	question="Start error check of all recordings (y/n)?"
else
	record=("$1")
	question="Start error check of the recording (y/n)?"
fi


read -p "$question " answer
case ${answer:0:1} in
    y|Y )
        echo "Start..."
    ;;
    * )
	echo "Abort!"
        exit 1
    ;;
esac


for DIR in  "${record[@]}"; do
	echo "Recording review: $DIR"

	if [ ! -r "$DIR"/00001.ts ]; then
		echo "File $DIR/00001.ts does not exist, skipping"
		continue
	fi

	if [ ! -r "$DIR"/info ]; then
		echo "File $DIR/info does not exist, skipping"
		continue
	fi

	if (cut -d\   -f1 "$DIR/info" | grep -q "O"); then
		echo "Recording was already checked, skipping"
		continue
	fi

	if [ ! -w "$DIR"/info ]; then
		echo "Cannot write to file $DIR/info, skipping"
		continue
	fi

	output=$("${VDR_CHECKTS}" "$DIR")
	echo $output

	errors=$(echo "$output" | cut -d\  -f2)

	echo "O $errors" >> "$DIR/info"
done
